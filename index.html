<html>
<head>
		<style>
			body {
				font-family: Monospace;
				background-color: #555555;
				margin: 0px;
				overflow: hidden;
			}
		</style>
</head>
<body>
<script src="scripts/three.min.js"></script>
<script src="scripts/FirstPersonControls.js"></script>
<script>
    var container;

    var camera, scene, renderer;
    var pointLight;
    
    var sphereRadius = 0.05;
    
    // this is a dictionnary of joints by player, formatted as such: <playerId, <jointName, sphere>>
    var playersJoints = {};
    
    var controls;
    var clock = new THREE.Clock();
  

   /* var players = {"8": {
        "HipCenter":{"X":0.0,"Y":0.0,"Z":0.0},
        "Spine":{"X":0.0,"Y":0.0,"Z":0.0},
        "ShoulderCenter":{"X":0.0,"Y":0.0,"Z":0.0},
        "Head":{"X":0.08668527,"Y":0.0220835712,"Z":0.319103956},
        "ShoulderLeft":{"X":0.0,"Y":0.0,"Z":0.0},
        "ElbowLeft":{"X":0.108794481,"Y":0.009790122,"Z":0.319360435},
        "WristLeft":{"X":0.2020339,"Y":-0.0248778015,"Z":0.5918199},
        "HandLeft":{"X":0.231782481,"Y":0.0392407924,"Z":0.6061543},
        "ShoulderRight":{"X":0.0,"Y":0.0,"Z":0.0},
        "ElbowRight":{"X":0.108968683,"Y":0.007372449,"Z":0.319366753},
        "WristRight":{"X":0.21582225,"Y":0.0241406485,"Z":0.5886469},
        "HandRight":{"X":0.2514401,"Y":0.029730048,"Z":0.682654142},
        "HipLeft":{"X":0.0,"Y":0.0,"Z":0.0},
        "KneeLeft":{"X":0.0,"Y":0.0,"Z":0.0},
        "AnkleLeft":{"X":0.122794874,"Y":0.0340408348,"Z":0.391988426},
        "FootLeft":{"X":0.164369971,"Y":0.0492028147,"Z":0.490289539},
        "HipRight":{"X":0.0,"Y":0.0,"Z":0.0},
        "KneeRight":{"X":0.0,"Y":0.0,"Z":0.0},
        "AnkleRight":{"X":0.135660678,"Y":0.0545658,"Z":0.384651929},
        "FootRight":{"X":0.171393216,"Y":0.04367411,"Z":0.485775828}}};
    */
    var players = {"player1": {
        "Head": {"X": 0.1, "Y": 0.5, "Z": 0.1},
        "Spine": {"X": 0.1, "Y": 0.1, "Z":0.1 },
    }};
    init();
    animate();    

    function drawSphere(playerId, jointName, x, y, z, color)
    {
        // Ignore missing/invalid joints:
        //if (x == 0 && y == 0 && z == 0)
          //  return ;
        if (!(playerId in playersJoints))
            playersJoints[playerId] = {};
        if (!(jointName in playersJoints[playerId]))
        {
            material = new THREE.MeshLambertMaterial( { color: color, shading: THREE.SmoothShading } );
        
            var geometry = new THREE.SphereGeometry( sphereRadius, 32, 16 );
            var sphere = new THREE.Mesh( geometry, material );

            sphere.position.x = x;
            sphere.position.y = y;
            sphere.position.z = z;

            scene.add(sphere);
            playersJoints[playerId][jointName] = sphere;
            //alert("Creating "+ playerId + "::" + jointName);
        }
        else
        {
            var sphere = playersJoints[playerId][jointName];
            sphere.position.x = x;
            sphere.position.y = y;
            sphere.position.z = y;
        }
    }
    
    function drawBones(playerId, origin, target, color)
    {
        if (!(origin in playersJoints[playerId]) || !(target in playersJoints[playerId]))
            return;
        var boneName = origin + target;
        if (!(boneName in playersJoints[playerId]))
        {
            var lineMaterial = new THREE.LineBasicMaterial({color: color});
            var geometry = new THREE.Geometry();
            geometry.vertices.push(playersJoints[playerId][origin].position);
            geometry.vertices.push(playersJoints[playerId][target].position);
            var line = new THREE.Line(geometry, lineMaterial);
            scene.add(line);   
            playersJoints[playerId][boneName] = line;
        }
        else
        {
            // No need to update the position itself, the position is a reference to the actual sphere's position
            var line = playersJoints[playerId][boneName];
            line.geometry.verticesNeedUpdate = true;
        }
    }
    
    function drawPlayer(playerId, player)
    {
        for (var jointName in player)
        {
            pos = player[jointName];
            drawSphere(playerId, jointName, pos.X, pos.Y, pos.Z, 0xFF0000);
        }
        drawBones(playerId, "Head", "Spine", 0x0000FF);
    }
    
    function initWebsocket(host)
    {
        if (!('WebSocket' in window))
            return false;

        var connection = new WebSocket(host);

        connection.onopen = function()
        {
            console.log('Connection opened');
        }

        connection.onclose = function()
        {
            console.log('Connection closed');
        }

        connection.onerror = function(error)
        {
            console.log('Error is detected: ' + error);
        }
 
        connection.onmessage = function(e)
        {
            var server_message = e.data;
            console.log(server_message);
        }
    }
    
    function init() 
    {
        container = document.createElement( 'div' );
        document.body.appendChild( container );

        camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.0001, 2000 );
        camera.position.set(-2, 0, 0);
        camera.lookAt(0, 0, 0);

        controls = new THREE.FirstPersonControls( camera );
        controls.movementSpeed = 1;
        controls.lookSpeed = 0.125;
        controls.lookVertical = true;
        controls.constrainVertical = true;
        controls.verticalMin = 1.1;
        controls.verticalMax = 2.2;
        //controls.activeLook = false;
        
        scene = new THREE.Scene();

        for (var playerId in players)
            drawPlayer(playerId, players[playerId]);
        // Lights
        pointLight = new THREE.PointLight( 0xffffff, 1 );
        scene.add( pointLight );
        
        // Lights
        scene.add( new THREE.AmbientLight( 0x111111 ) );

        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setSize( window.innerWidth, window.innerHeight );
        container.appendChild( renderer.domElement );

        window.addEventListener( 'resize', onWindowResize, false );
        initWebsocket("ws://garagepurple.cloudapp.net:2012");
    }

    function onWindowResize()
    {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );
        controls.handleResize();
    }

    
    function animate() 
    {
        requestAnimationFrame( animate );
        render();
    }

    function render() 
    {
        var timer = 0.0001 * Date.now();

        pointLight.position.x = Math.sin( timer * 7 ) * 300;
        pointLight.position.y = Math.cos( timer * 5 ) * 400;
        pointLight.position.z = Math.cos( timer * 3 ) * 300;
        
        players["player1"]["Head"].X = Math.sin( timer * 100 ) * 10;
        players["player1"]["Head"].Z = Math.sin( timer * 100 ) * 10;
        drawPlayer("player1", players["player1"]);
       
        controls.update( clock.getDelta() );
        renderer.render( scene, camera );
    }

</script>
</body>
</html>